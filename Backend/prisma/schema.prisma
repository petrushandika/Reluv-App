generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER
  ADMIN
}

enum Condition {
  NEW
  LIKE_NEW
  GOOD
  FAIR
  POOR
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  EXPIRED
  CANCELLED
}

enum ShipmentStatus {
  AWAITING_PICKUP
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  RETURNED
  CANCELLED
}

enum VoucherType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

enum NotificationType {
  ORDER_CREATED
  ORDER_PAID
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  REVIEW_RECEIVED
  PRODUCT_LOW_STOCK
  VOUCHER_APPLIED
  PAYMENT_FAILED
  SHIPMENT_UPDATED
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

enum DiscountScope {
  GLOBAL
  CATEGORY
  PRODUCT
  STORE
}

enum PromotionType {
  FLASH_SALE
  BOGO
  BUNDLE
  SEASONAL
  CUSTOM
}

enum BadgeType {
  VERIFIED
  PREMIUM
  FEATURED
  TRENDING
  BEST_SELLER
  NEW_STORE
  CUSTOM
}

model User {
  id         Int       @id @default(autoincrement())
  googleId   String?   @unique
  facebookId String?   @unique
  firstName  String?
  lastName   String?
  email      String    @unique
  password   String?
  phone      String?
  birth      DateTime?
  role       UserRole  @default(USER)
  isActive   Boolean   @default(true)
  isVerified Boolean   @default(false)

  verificationToken       String?
  verificationTokenExpiry DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  locations     Location[]
  products      Product[]
  reviews       Review[]
  orders        Order[]
  cart          Cart?
  profile       UserProfile?
  wishlist      Wishlist[]
  notifications Notification[]
  store         Store?
  voucherUsages VoucherUsage[]

  @@index([email])
  @@index([isActive, isVerified])
  @@map("users")
}

model UserProfile {
  id     Int     @id @default(autoincrement())
  avatar String?
  banner String?
  bio    String?
  gender Gender?

  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId Int  @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_profiles")
}

model Store {
  id         Int     @id @default(autoincrement())
  name       String
  slug       String  @unique
  isActive   Boolean @default(true)
  isVerified Boolean @default(false)

  totalProducts Int    @default(0)
  totalSales    Int    @default(0)
  rating        Float? @db.Real

  profile  StoreProfile?
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId   Int           @unique
  products Product[]

  location   Location? @relation("StoreLocation")
  locationId Int?      @unique

  discounts    Discount[]
  promotions   Promotion[]
  badges       Badge[]
  vouchers     Voucher[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([slug])
  @@index([isActive, isVerified])
  @@map("store")
}

model StoreProfile {
  id          Int     @id @default(autoincrement())
  avatar      String?
  banner      String?
  bio         String?
  operational String?

  store   Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  storeId Int   @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("store_profiles")
}

model Location {
  id          Int     @id @default(autoincrement())
  label       String
  recipient   String
  phone       String
  province    String
  city        String
  district    String
  subDistrict String
  postalCode  String
  address     String  @db.Text
  isDefault   Boolean @default(false)

  latitude         Float?
  longitude        Float?
  biteship_area_id String?

  user   User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId Int?

  store   Store? @relation("StoreLocation", fields: [storeId], references: [id], onDelete: SetNull)
  storeId Int?   @unique

  orders Order[]

  @@index([userId])
  @@index([storeId])
  @@map("locations")
}

model Category {
  id   Int    @id @default(autoincrement())
  name String
  slug String @unique

  products       Product[] @relation("ProductCategory")
  parentProducts Product[] @relation("ProductParentCategory")
  childProducts  Product[] @relation("ProductChildCategory")

  parentId        Int?
  parentCategory  Category?  @relation("SubCategories", fields: [parentId], references: [id], onDelete: Restrict)
  childCategories Category[] @relation("SubCategories")

  discounts Discount[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("categories")
}

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  slug        String   @unique
  description String   @db.Text
  images      String[]
  isPublished Boolean  @default(true)
  isPreloved  Boolean  @default(true)
  isActive    Boolean  @default(true)
  viewCount   Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  seller   User @relation(fields: [sellerId], references: [id], onDelete: Restrict)
  sellerId Int

  category   Category @relation("ProductCategory", fields: [categoryId], references: [id], onDelete: Restrict)
  categoryId Int

  parentCategory   Category? @relation("ProductParentCategory", fields: [parentCategoryId], references: [id], onDelete: Restrict)
  parentCategoryId Int?

  childCategory   Category? @relation("ProductChildCategory", fields: [childCategoryId], references: [id], onDelete: Restrict)
  childCategoryId Int?

  store   Store? @relation(fields: [storeId], references: [id], onDelete: SetNull)
  storeId Int?

  discounts   Discount[]
  promotions  Promotion[]

  variants Variant[]
  reviews  Review[]
  wishlist Wishlist[]

  @@index([sellerId, isPublished, isActive])
  @@index([categoryId])
  @@index([parentCategoryId])
  @@index([childCategoryId])
  @@index([storeId])
  @@index([slug])
  @@index([isPublished, isActive, createdAt])
  @@map("products")
}

model Variant {
  id        Int     @id @default(autoincrement())
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId Int

  size  String?
  color String?
  sku   String? @unique
  image String?

  price          Int
  compareAtPrice Int?

  stock         Int       @default(1)
  condition     Condition
  conditionNote String?

  weight Int
  length Int
  width  Int
  height Int

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orderItems OrderItem[]
  cartItems  CartItem[]

  @@index([productId, isActive])
  @@index([sku])
  @@map("variants")
}

model Wishlist {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId Int
  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@map("wishlists")
}

model Cart {
  id     Int        @id @default(autoincrement())
  user   User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId Int        @unique
  items  CartItem[]

  @@map("carts")
}

model CartItem {
  id        Int      @id @default(autoincrement())
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  cartId    Int
  variant   Variant  @relation(fields: [variantId], references: [id], onDelete: Cascade)
  variantId Int
  quantity  Int
  createdAt DateTime @default(now())

  @@unique([cartId, variantId])
  @@index([cartId])
  @@index([variantId])
  @@map("cart_items")
}

model Voucher {
  id          Int         @id @default(autoincrement())
  code        String      @unique
  name        String
  description String?
  type        VoucherType
  value       Int
  maxDiscount Int?
  minPurchase Int?
  usageLimit  Int?
  expiry      DateTime
  isActive    Boolean     @default(true)

  store   Store? @relation(fields: [storeId], references: [id], onDelete: Cascade)
  storeId Int?

  usages VoucherUsage[]
  orders Order[] @relation("OrderVoucher")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code, isActive, expiry])
  @@index([storeId])
  @@map("vouchers")
}

model VoucherUsage {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  voucherId Int
  voucher   Voucher  @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  usedAt    DateTime @default(now())

  order   Order? @relation("OrderVoucherUsage")
  orderId Int?   @unique

  @@unique([userId, voucherId])
  @@index([userId])
  @@index([voucherId])
  @@index([orderId])
  @@map("voucher_usages")
}

model Review {
  id      Int      @id @default(autoincrement())
  rating  Int      @db.SmallInt
  comment String?  @db.Text
  images  String[]

  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId Int
  author    User    @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId  Int

  isVerified  Boolean @default(false)
  helpfulCount Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, authorId])
  @@index([productId, rating])
  @@index([authorId])
  @@map("reviews")
}

model Order {
  id             Int         @id @default(autoincrement())
  orderNumber    String      @unique
  totalAmount    Int
  itemsAmount    Int
  shippingCost   Int         @default(0)
  discountAmount Int         @default(0)
  voucherCode    String?
  status         OrderStatus @default(PENDING)
  notes          String?     @db.Text
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  buyer      User     @relation(fields: [buyerId], references: [id], onDelete: Restrict)
  buyerId    Int
  location   Location @relation(fields: [locationId], references: [id], onDelete: Restrict)
  locationId Int

  voucherId Int?
  voucher   Voucher? @relation("OrderVoucher", fields: [voucherId], references: [id], onDelete: SetNull)

  voucherUsageId Int?   @unique
  voucherUsage   VoucherUsage? @relation("OrderVoucherUsage", fields: [voucherUsageId], references: [id], onDelete: SetNull)

  items    OrderItem[]
  payment  Payment?
  shipment Shipment?

  @@index([buyerId, status])
  @@index([status])
  @@index([createdAt])
  @@index([orderNumber])
  @@index([voucherId])
  @@index([voucherUsageId])
  @@map("orders")
}

model OrderItem {
  id       Int @id @default(autoincrement())
  quantity Int
  price    Int
  total    Int

  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId   Int
  variant   Variant @relation(fields: [variantId], references: [id], onDelete: Restrict)
  variantId Int

  @@index([orderId])
  @@index([variantId])
  @@map("order_items")
}

model Payment {
  id     Int           @id @default(autoincrement())
  method String?
  amount Int
  status PaymentStatus @default(PENDING)

  snap_token            String? @unique
  snap_redirect_url     String?
  midtrans_order_id     String  @unique
  midtrans_tx_id        String? @unique @map("midtrans_transaction_id")
  midtrans_payment_type String?
  midtrans_va_number    String?
  midtrans_bank         String?
  midtrans_tx_status    String? @map("midtrans_transaction_status")
  midtrans_fraud_status String?

  gatewayResponse Json?

  paidAt    DateTime?
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  order   Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId Int   @unique

  @@index([status])
  @@index([midtrans_order_id])
  @@index([orderId])
  @@map("payments")
}

model Notification {
  id        Int             @id @default(autoincrement())
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  title     String
  body      String          @db.Text
  type      NotificationType?
  actionUrl String?
  data      Json?
  isRead    Boolean         @default(false)
  createdAt DateTime        @default(now())

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([type])
  @@map("notifications")
}

model Shipment {
  id             Int            @id @default(autoincrement())
  courier        String
  service        String
  trackingNumber String?        @unique
  status         ShipmentStatus @default(AWAITING_PICKUP)

  biteship_order_id     String? @unique
  biteship_courier_code String?
  biteship_service_code String?

  estimatedDays String?
  shippingCost  Int?    @map("shipping_cost")
  insuranceCost Int?    @default(0) @map("insurance_cost")

  biteshipResponse Json?
  trackingHistory  Json[]

  shippedAt   DateTime?
  deliveredAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  order   Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId Int   @unique

  @@index([trackingNumber])
  @@index([status])
  @@index([orderId])
  @@map("shipments")
}

model ShippingRate {
  id                Int      @id @default(autoincrement())
  originAreaId      String
  destinationAreaId String
  courierCode       String
  serviceCode       String
  serviceName       String
  price             Int
  minWeight         Int
  maxWeight         Int
  estimatedDays     String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([originAreaId, destinationAreaId, courierCode, serviceCode])
  @@map("shipping_rates")
}

model Discount {
  id          Int           @id @default(autoincrement())
  name        String
  description String?        @db.Text
  type        DiscountType
  value       Int
  maxDiscount Int?
  minPurchase Int?
  scope       DiscountScope
  isActive    Boolean        @default(true)

  startDate DateTime
  endDate   DateTime

  categoryId Int?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  productId Int?
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  storeId Int?
  store    Store? @relation(fields: [storeId], references: [id], onDelete: Cascade)

  usageLimit Int?
  usedCount  Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([scope])
  @@index([isActive, startDate, endDate])
  @@index([categoryId])
  @@index([productId])
  @@index([storeId])
  @@map("discounts")
}

model Promotion {
  id          Int            @id @default(autoincrement())
  name        String
  type        PromotionType
  description String?        @db.Text
  discount    Float?
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean        @default(true)

  store   Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  storeId Int

  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId])
  @@index([startDate, endDate])
  @@index([isActive])
  @@map("promotions")
}

model Badge {
  id          Int       @id @default(autoincrement())
  type        BadgeType
  name        String
  description String?    @db.Text
  icon        String?
  color       String?
  isActive    Boolean   @default(true)

  store   Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  storeId Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId])
  @@index([type, isActive])
  @@map("badges")
}
